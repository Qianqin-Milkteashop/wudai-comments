<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理工具</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    .admin-wrap { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .admin-card { background: var(--color-bg-secondary); border:2px solid var(--color-border-dark); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-md); margin-bottom: 1.5rem; }
    code { background: var(--color-bg); padding: .15rem .4rem; border-radius: 6px; border:1px solid var(--color-border); }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1 class="title">管理工具</h1>
    </div>
  </header>

  <div class="admin-wrap">
    <div class="admin-card">
      <h2 style="margin-bottom:1rem;">1）登录（Cloudflare Access）</h2>
      <p class="help-text">
        本页不包含任何<b>密码</b>。管理员权限由 Cloudflare Access 管理。<br/>
        点击下方按钮。如果你已在 Cloudflare Access 中为 <code>/api/admin/*</code> 开启保护，浏览器会提示你登录。
      </p>
      <button class="btn btn-primary" id="btnAdminPing">登录 / 验证权限</button>
      <p class="help-text" id="adminStatus"></p>
    </div>

    <div class="admin-card">
      <h2 style="margin-bottom:1rem;">2）导出数据</h2>
      <p class="help-text">将当前数据导出为 JSON。</p>
      <button class="btn btn-secondary" id="btnExport">导出 JSON</button>
    </div>

    <div class="admin-card">
      <h2 style="margin-bottom:1rem;">3）导入数据</h2>
      <p class="help-text">上传之前导出的 JSON，用它覆盖数据库当前数据。</p>
      <input type="file" id="importFile" class="input" accept="application/json" />
      <div style="height: .75rem;"></div>
      <button class="btn btn-danger" id="btnImport">导入（覆盖）</button>
      <p class="help-text" id="importHint"></p>
    </div>

    <div class="admin-card">
      <h2 style="margin-bottom:1rem;">4）返回</h2>
      <a class="btn btn-secondary" href="./index.html">返回网站</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---- CONFIG: set your Worker base URL here ----
    // Example: https://wudai-sync-api.yourname.workers.dev
    const API_BASE = localStorage.getItem('WUDAI_API_BASE') || '';

    const toast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2000);
    };

    async function api(path, options = {}) {
      const url = (API_BASE || '').replace(/\/$/, '') + path;
      const res = await fetch(url, {
        credentials: 'include',
        ...options,
        headers: {
          'content-type': 'application/json',
          ...(options.headers || {})
        }
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
      return data;
    }

    document.getElementById('btnAdminPing').addEventListener('click', async () => {
      try {
        const r = await api('/api/admin/ping', { method:'GET' });
        document.getElementById('adminStatus').textContent = '✅ 权限正常：' + (r.email || 'admin');
        toast('权限已验证');
      } catch (e) {
        document.getElementById('adminStatus').textContent = '❌ ' + e.message;
        toast('权限验证失败');
      }
    });

    document.getElementById('btnExport').addEventListener('click', async () => {
      try {
        const state = await api('/api/admin/export', { method:'GET' });
        const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'wudai-export.json';
        a.click();
        toast('已导出');
      } catch (e) {
        toast('导出失败：' + e.message);
      }
    });

    document.getElementById('btnImport').addEventListener('click', async () => {
      const f = document.getElementById('importFile').files[0];
      if (!f) { toast('请选择一个 JSON 文件'); return; }
      try {
        const text = await f.text();
        const payload = JSON.parse(text);
        await api('/api/admin/import', { method:'POST', body: JSON.stringify(payload) });
        toast('已导入');
        document.getElementById('importHint').textContent = '✅ 已导入。 请刷新主页面。';
      } catch (e) {
        toast('导入失败：' + e.message);
        document.getElementById('importHint').textContent = '❌ ' + e.message;
      }
    });
  </script>
</body>
</html>
