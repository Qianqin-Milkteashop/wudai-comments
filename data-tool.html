<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç®¡ç†å·¥å…· - äº”ä»£åå›½å…³ç³»å›¾</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .tool-container {
            max-width: 900px;
            margin: 3rem auto;
            padding: 2rem;
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border-dark);
        }
        
        .tool-section {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .tool-section:last-child {
            border-bottom: none;
        }
        
        .tool-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }
        
        .tool-desc {
            color: var(--color-text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .code-block {
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 0.625rem 1.5rem;
            border: 2px solid var(--color-border-dark);
            background: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            letter-spacing: 0.05em;
        }
        
        .file-label:hover {
            background: var(--color-accent);
            color: var(--color-bg);
        }
        
        .success {
            color: #0a8a0a;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .error {
            color: var(--color-danger);
            font-weight: 600;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="grid-overlay"></div>
    </div>
    
    <header class="header">
        <div class="container">
            <h1 class="title">æ•°æ®ç®¡ç†å·¥å…·</h1>
            <p class="subtitle">å¯¼å…¥ / å¯¼å‡º / å¤‡ä»½</p>
            <div class="header-actions">
                <a href="index.html" class="btn btn-secondary">è¿”å›ä¸»é¡µ</a>
            </div>
        </div>
    </header>
    
    <div id="adminGate" class="tool-container" style="max-width: 520px; display: none;">
        <section class="tool-section" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
            <h2 class="tool-title">ğŸ” Admin access</h2>
            <p class="tool-desc">This page is for administrators only. Please enter the admin password.</p>
            <input type="password" id="adminPassword" class="input" placeholder="Admin password" autocomplete="current-password">
            <div class="btn-group" style="margin-top: 1rem;">
                <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
                <a href="index.html" class="btn btn-secondary">Back</a>
            </div>
            <div id="adminGateResult"></div>
        </section>
    </div>

    <main id="toolMain" class="tool-container" style="display: none;">
        <!-- å¯¼å‡ºæ•°æ® -->
        <section class="tool-section">
            <h2 class="tool-title">ğŸ“¦ å¯¼å‡ºå½“å‰æ•°æ®</h2>
            <p class="tool-desc">å°†æµè§ˆå™¨ä¸­ä¿å­˜çš„æ•°æ®å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼Œç”¨äºå¤‡ä»½æˆ–è¿ç§»åˆ°å…¶ä»–è®¾å¤‡ã€‚</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportData()">å¯¼å‡ºJSONæ–‡ä»¶</button>
                <button class="btn btn-secondary" onclick="copyToClipboard()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            <div id="exportResult"></div>
        </section>
        
        <!-- å¯¼å…¥æ•°æ® -->
        <section class="tool-section">
            <h2 class="tool-title">ğŸ“¥ å¯¼å…¥æ•°æ®</h2>
            <p class="tool-desc">ä»JSONæ–‡ä»¶å¯¼å…¥æ•°æ®ã€‚âš ï¸ æ³¨æ„ï¼šè¿™å°†<strong>è¦†ç›–</strong>å½“å‰æ‰€æœ‰æ•°æ®ï¼</p>
            <div class="btn-group">
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="importFromFile()">
                <label for="fileInput" class="file-label">é€‰æ‹©JSONæ–‡ä»¶</label>
                <button class="btn btn-secondary" onclick="importFromExample()">å¯¼å…¥ç¤ºä¾‹æ•°æ®</button>
            </div>
            <div id="importResult"></div>
        </section>
        
        <!-- æ¸…ç©ºæ•°æ® -->
        <section class="tool-section">
            <h2 class="tool-title">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</h2>
            <p class="tool-desc">æ¸…ç©ºæµè§ˆå™¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚âš ï¸ æ­¤æ“ä½œ<strong>ä¸å¯æ’¤é”€</strong>ï¼</p>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-secondary" onclick="clearPendingChanges()">ä»…æ¸…ç©ºå¾…å®¡æ ¸ä¿®æ”¹</button>
            </div>
            <div id="clearResult"></div>
        </section>
        
        <!-- æŸ¥çœ‹åŸå§‹æ•°æ® -->
        <section class="tool-section">
            <h2 class="tool-title">ğŸ” æŸ¥çœ‹åŸå§‹æ•°æ®</h2>
            <p class="tool-desc">æŸ¥çœ‹æµè§ˆå™¨ä¸­ä¿å­˜çš„åŸå§‹JSONæ•°æ®ã€‚</p>
            <button class="btn btn-secondary" onclick="viewRawData()">æ˜¾ç¤ºåŸå§‹æ•°æ®</button>
            <div id="rawDataContainer"></div>
        </section>
    </main>
    
    <script>

        // Same storage namespace as app.js (important for GitHub Pages: localStorage is shared across repos)
        const STORAGE = {
            prefix: 'wudai_v2_',
            key(name) { return `${this.prefix}${name}`; },
            legacy: {
                adminPasswordHash: 'adminPasswordHash',
                graphData: 'graphData',
                comments: 'comments',
            }
        };

        function migrateKey(newKey, legacyKey) {
            if (localStorage.getItem(newKey) === null) {
                const legacyVal = localStorage.getItem(legacyKey);
                if (legacyVal !== null) {
                    localStorage.setItem(newKey, legacyVal);
                }
            }
        }

        // Admin gate (session-based)
        const ADMIN_SESSION = {
            key: STORAGE.key('adminSession'),
            timeKey: STORAGE.key('adminSessionTime'),
            legacyKey: 'adminSession',
            legacyTimeKey: 'adminSessionTime',
            maxAge: 12 * 60 * 60 * 1000 // 12 hours
        };

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function setAdminSession() {
            sessionStorage.setItem(ADMIN_SESSION.key, 'true');
            sessionStorage.setItem(ADMIN_SESSION.timeKey, Date.now().toString());
            sessionStorage.removeItem(ADMIN_SESSION.legacyKey);
            sessionStorage.removeItem(ADMIN_SESSION.legacyTimeKey);
        }

        function clearAdminSession() {
            sessionStorage.removeItem(ADMIN_SESSION.key);
            sessionStorage.removeItem(ADMIN_SESSION.timeKey);
            sessionStorage.removeItem(ADMIN_SESSION.legacyKey);
            sessionStorage.removeItem(ADMIN_SESSION.legacyTimeKey);
        }

        function isAdminSessionValid() {
            const hasNew = sessionStorage.getItem(ADMIN_SESSION.key) === 'true';
            const hasLegacy = sessionStorage.getItem(ADMIN_SESSION.legacyKey) === 'true';
            if (!hasNew && !hasLegacy) return false;

            const t = parseInt(
                (sessionStorage.getItem(ADMIN_SESSION.timeKey) || sessionStorage.getItem(ADMIN_SESSION.legacyTimeKey) || '0'),
                10
            );
            if (!t) return false;
            if (Date.now() - t > ADMIN_SESSION.maxAge) {
                clearAdminSession();
                return false;
            }
            // migrate legacy -> new
            if (!hasNew && hasLegacy) setAdminSession();
            return true;
        }

        function showGate(message, type = 'error') {
            const gate = document.getElementById('adminGate');
            const main = document.getElementById('toolMain');
            gate.style.display = 'block';
            main.style.display = 'none';
            if (message) {
                showMessage('adminGateResult', message, type);
            }
        }

        function showMain() {
            document.getElementById('adminGate').style.display = 'none';
            document.getElementById('toolMain').style.display = 'block';
        }

        function ensureAdmin() {
            migrateKey(STORAGE.key('adminPasswordHash'), STORAGE.legacy.adminPasswordHash);
            if (!localStorage.getItem(STORAGE.key('adminPasswordHash'))) {
                showGate('âŒ Admin password is not set. Please set it on the home page (Ctrl+Alt+Shift+A, backup: Ctrl+Shift+L).');
                return false;
            }
            if (!isAdminSessionValid()) {
                showGate('âŒ Admin login required.');
                return false;
            }
            return true;
        }

        async function loginAdmin() {
            const pwd = document.getElementById('adminPassword').value;
            if (!pwd) {
                showMessage('adminGateResult', 'Please enter a password.', 'error');
                return;
            }
            migrateKey(STORAGE.key('adminPasswordHash'), STORAGE.legacy.adminPasswordHash);
            const savedHash = localStorage.getItem(STORAGE.key('adminPasswordHash'));
            if (!savedHash) {
                showGate('âŒ Admin password is not set. Please set it on the home page (Ctrl+Alt+Shift+A, backup: Ctrl+Shift+L).');
                return;
            }
            const hash = await hashPassword(pwd);
            if (hash === savedHash) {
                setAdminSession();
                showMain();
                showMessage('exportResult', 'âœ… Admin session active.', 'success');
            } else {
                showMessage('adminGateResult', 'âŒ Wrong password.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            migrateKey(STORAGE.key('adminPasswordHash'), STORAGE.legacy.adminPasswordHash);
            if (!localStorage.getItem(STORAGE.key('adminPasswordHash'))) {
                showGate('âŒ Admin password is not set. Please set it on the home page (Ctrl+Alt+Shift+A, backup: Ctrl+Shift+L).');
                return;
            }
            if (isAdminSessionValid()) {
                showMain();
            } else {
                showGate(null);
            }
        });


        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<p class="${type}">${message}</p>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!ensureAdmin()) return;
            migrateKey(STORAGE.key('graphData'), STORAGE.legacy.graphData);
            migrateKey(STORAGE.key('comments'), STORAGE.legacy.comments);

            const graphStr = localStorage.getItem(STORAGE.key('graphData'));
            const commentsStr = localStorage.getItem(STORAGE.key('comments'));

            if (!graphStr && !commentsStr) {
                showMessage('exportResult', 'âŒ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            const payload = {
                version: 'wudai-v2',
                exportedAt: new Date().toISOString(),
                graphData: graphStr ? JSON.parse(graphStr) : null,
                comments: commentsStr ? JSON.parse(commentsStr) : []
            };

            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wudai-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('exportResult', 'âœ… æ•°æ®å·²å¯¼å‡ºï¼');
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            if (!ensureAdmin()) return;
            migrateKey(STORAGE.key('graphData'), STORAGE.legacy.graphData);
            migrateKey(STORAGE.key('comments'), STORAGE.legacy.comments);

            const graphStr = localStorage.getItem(STORAGE.key('graphData'));
            const commentsStr = localStorage.getItem(STORAGE.key('comments'));

            if (!graphStr && !commentsStr) {
                showMessage('exportResult', 'âŒ æ²¡æœ‰æ•°æ®å¯å¤åˆ¶', 'error');
                return;
            }

            const payload = {
                version: 'wudai-v2',
                exportedAt: new Date().toISOString(),
                graphData: graphStr ? JSON.parse(graphStr) : null,
                comments: commentsStr ? JSON.parse(commentsStr) : []
            };

            navigator.clipboard.writeText(JSON.stringify(payload, null, 2)).then(() => {
                showMessage('exportResult', 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                showMessage('exportResult', 'âŒ å¤åˆ¶å¤±è´¥', 'error');
            });
        }
        
        // ä»æ–‡ä»¶å¯¼å…¥
        function importFromFile() {
            if (!ensureAdmin()) return;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const payload = normalizeImportPayload(data);
                    if (!payload) {
                        showMessage('importResult', 'âŒ æ•°æ®æ ¼å¼ä¸æ­£ç¡®', 'error');
                        return;
                    }

                    localStorage.setItem(STORAGE.key('graphData'), JSON.stringify(payload.graphData));
                    if (payload.comments) {
                        localStorage.setItem(STORAGE.key('comments'), JSON.stringify(payload.comments));
                    }
                    showMessage('importResult', 'âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼è¯·åˆ·æ–°ä¸»é¡µã€‚');
                } catch (error) {
                    showMessage('importResult', 'âŒ JSONè§£æé”™è¯¯ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            fileInput.value = '';
        }
        
        // å¯¼å…¥ç¤ºä¾‹æ•°æ®
        async function importFromExample() {
            if (!ensureAdmin()) return;
            try {
                const response = await fetch('example-data.json');
                const data = await response.json();
                
                if (isGraphData(data)) {
                    localStorage.setItem(STORAGE.key('graphData'), JSON.stringify(data));
                    showMessage('importResult', 'âœ… ç¤ºä¾‹æ•°æ®å¯¼å…¥æˆåŠŸï¼è¯·åˆ·æ–°ä¸»é¡µã€‚');
                }
            } catch (error) {
                showMessage('importResult', 'âŒ åŠ è½½ç¤ºä¾‹æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // éªŒè¯æ•°æ®æ ¼å¼
        function isGraphData(obj) {
            return !!obj && typeof obj === 'object' && Array.isArray(obj.nodes) && Array.isArray(obj.links);
        }

        // æ”¯æŒä¸¤ç§å¯¼å…¥æ ¼å¼ï¼š
        // 1) æ—§æ ¼å¼ï¼š{ nodes:[], links:[] }
        // 2) å¤‡ä»½æ ¼å¼ï¼š{ version, exportedAt, graphData:{nodes,links}, comments:[] }
        function normalizeImportPayload(raw) {
            if (isGraphData(raw)) {
                return { graphData: raw, comments: null };
            }
            if (raw && typeof raw === 'object' && isGraphData(raw.graphData)) {
                const comments = Array.isArray(raw.comments) ? raw.comments : null;
                return { graphData: raw.graphData, comments };
            }
            return null;
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!ensureAdmin()) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            // åªæ¸…ç©ºæ•°æ®ï¼ˆä¸æ¸…ç©ºç®¡ç†å‘˜å¯†ç ï¼‰
            localStorage.removeItem(STORAGE.key('graphData'));
            localStorage.removeItem(STORAGE.key('comments'));
            localStorage.removeItem('pendingChanges');
            // legacy cleanups
            localStorage.removeItem(STORAGE.legacy.graphData);
            localStorage.removeItem(STORAGE.legacy.comments);
            showMessage('clearResult', 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
        }
        
        // æ¸…ç©ºå¾…å®¡æ ¸ä¿®æ”¹
        function clearPendingChanges() {
            if (!ensureAdmin()) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå¾…å®¡æ ¸çš„ä¿®æ”¹å—ï¼Ÿ')) {
                return;
            }
            
            localStorage.removeItem('pendingChanges');
            showMessage('clearResult', 'âœ… å¾…å®¡æ ¸ä¿®æ”¹å·²æ¸…ç©ºï¼');
        }
        
        // æŸ¥çœ‹åŸå§‹æ•°æ®
        function viewRawData() {
            if (!ensureAdmin()) return;
            migrateKey(STORAGE.key('graphData'), STORAGE.legacy.graphData);
            const data = localStorage.getItem(STORAGE.key('graphData'));
            const container = document.getElementById('rawDataContainer');
            
            if (!data) {
                container.innerHTML = '<div class="code-block">æ²¡æœ‰æ•°æ®</div>';
                return;
            }
            
            try {
                const formatted = JSON.stringify(JSON.parse(data), null, 2);
                container.innerHTML = `<div class="code-block"><pre>${formatted}</pre></div>`;
            } catch (error) {
                container.innerHTML = `<div class="code-block">${data}</div>`;
            }
        }
    </script>
</body>
</html>
